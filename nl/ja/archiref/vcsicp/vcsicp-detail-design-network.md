---

copyright:

  years:  2016, 2018

lastupdated: "2018-10-10"

---

# ネットワーク・アクセスおよびフロー

## コンテナー・アプリケーション・アクセス – ICP

Kubernetes クラスター・アプリケーションへの外部トラフィック/アクセス権限を取得するには、主に次の 3 つの方法があります。
- NodePort
- LoadBalancer
- Ingress

### NodePort
NodePort は、初期開発とテストの際にワークロードへの外部アクセス権限を付与するための簡単な方法ですが、実動には推奨されません。Ingress またはロード・バランサーが、推奨されるパスです。

### LoadBalancer
ICP プラットフォームは現在、アプリケーション・ワークロード用に外部ロード・バランサーをサポートしています。

### Ingress
Ingress は、インバウンド接続がクラスター・サービスに到達できるようにするルールの集合です。サービスへの外部到達可能 URL の提示、トラフィックのロード・バランシング、SSL の終了、名前ベースの仮想ホスティングの提供などを行うように構成できます。この機能は、ICP インフラストラクチャー内のプロキシー・ノードによって実行されます。

## コンテナー・アプリケーション・アクセス – IKS
Kubernetes クラスター・アプリケーションへの外部トラフィック/アクセス権限を取得するには、主に次の 3 つの方法があります。
- NodePort
- LoadBalancer
- Ingress

### NodePort
NodePort は、初期開発とテストの際にワークロードへの外部アクセス権限を付与するための簡単な方法ですが、実動には推奨されません。Ingress またはロード・バランサーが、推奨されるパスです。

### LoadBalancer
どの IKS クラスターも、パブリック/プライベート Application Load Balancer (ALB) とともにプロビジョンされます。ALB は、保護された固有のパブリック・エントリー・ポイントまたはプライベート・エントリー・ポイントを使用して、着信要求をアプリにルーティングします。

### Ingress
Ingress は、インバウンド接続がクラスター・サービスに到達できるようにするルールの集合です。サービスへの外部到達可能 URL の提示、トラフィックのロード・バランシング、SSL の終了、名前ベースの仮想ホスティングの提供などを行うように構成できます。

## トラフィック・フロー
以下のトラフィック・フローについて説明します。
- インターネット上の外部ユーザーから ICP のコンテナーでホストされる Web 層まで。
- ICP のコンテナーでホストされる Web 層から VCS の VM でホストされるデータベース層まで。
- 企業ネットワーク・アクセスが可能なエンタープライズ・ユーザーから VCS の VM まで。

### インターネット上の外部ユーザーから ICP のコンテナーでホストされる Web 層まで。
1. 外部ユーザーが URL を使用して Web 層に要求を出します。
2.	DNS を使用して IP アドレスが判別されます。この IP アドレスが、VCS インスタンスに割り当てられたポータブル・サブネット上の IBM Cloud パブリック・アドレスになります。
3.	ESG をホストする vSphere ESXi ホストに要求がパブリック・ネットワークで自動的に転送されます。
4.	ESG が要求を ALB または Ingress サービスの内部クラスター IP アドレスおよびポート番号に転送します。ESG と ALB または Ingress サービスが別々の vSphere ESXi ホスト上にある場合、IP パケットは VXLAN フレームにカプセル化されます。この内部クラスター IP アドレスはクラスター内でのみアクセス可能です。
5.	ワーカー・ノード内で、kube-proxy が要求を ALB または Ingress サービスにルーティングします。
6.	同じワーカー・ノード上にアプリがある場合は、iptables を使用して、要求の転送に使用される内部インターフェースが判別されます。別のワーカー・ノード上にアプリがある場合は、Calico vRouter が IP-in-IP カプセル化を使用して、該当するワーカー・ノードにルーティングします。IP-in-IP パケットは、ワーカー・ノードが置かれている vSphere ESXi ホストへの転送のために、VXLAN フレームにカプセル化されます。

### ICP のコンテナーでホストされる Web 層から VCS の VM でホストされるデータベース層まで。
ESG と vRouter 内の経路テーブルにどのようにデータが取り込まれるかは、統合方式によって異なります。「ICP と VCS の統合」を参照してください。
1.	ICP のコンテナーで実行されている Web 層が、同じ VCS インスタンス内の VM 上で実行されているデータベースに要求を出します。
2.	DNS を使用して、要求がデータベースの IP アドレスとして解決されます。
3.	コンテナーが Calico vRouter に要求を送信します。
4.	vRouter の経路テーブルには、VCS インスタンスでホストされている IP アドレス範囲が取り込まれています。
5.	vRouter が要求を転送しますが、SNAT を使用して、ソース IP アドレスをポッドの IP アドレスからワーカー・ノードの IP アドレスに変更します。
6.	vRouter をホストするワーカー・ノードが要求を ESG に送信します。
7.	その後 ESG は DLR に転送します。
8.	DLR が要求を必要な VXLAN 上に置きます。
9.	データベース VM が要求を受け取ります。

### 	企業ネットワーク・アクセスが可能なエンタープライズ・ユーザーから VCS の VM まで
1.	企業の社内ネットワークに接続されているエンタープライズ・ユーザーが、VCS でホストされている VM 上のリソースの要求を行います。
2.	DNS を使用して VM の IP アドレスが判別されます。この IP アドレスは、IBM Cloud まで拡張されたネットワーク上にあります。
3.	オンプレミス・ルーターが、L2 コンセントレーターをホストしている vSphere ホストにトラフィックを送信します。
4.	L2 コンセントレーターがセキュア・トンネルで要求をカプセル化し、IBM Cloud でホストされているリモート L2 コンセントレーターにオンプレミス・ルーター経由で転送します。このとき、デバイスに割り当てられたプライベート・ポータブル・サブネット IP アドレスが使用されます。
5.	オンプレミス経路では、そのルーティング・テーブルを調べて、リモート L2 コンセントレーターの IP アドレスを WAN インターフェースに送信する必要があることを認識し、BCR 経由で IBM Cloud XCR ルーターを介して WAN 上で転送します。
6.	L2 コンセントレーターが要求を受信し、拡張ネットワークをホストする VXLAN 上に置きます。
7.	VM が要求を受け取ります。

## パブリック・アクセス・ネットワーク
ICP と CAM は、Docker イメージ、Helm チャート、Terraform テンプレート、オペレーティング・システムのパッケージ・マネージャーを取得するために、デフォルトでインターネット接続を必要とします。
最新リリースでは、インターネットに直接接続されていない、オフライン・モードでインストールするオプションがあるインストール環境のためのプロキシー・ベースのインストールがサポートされるようになりました。

###	NSX ファイアウォール
ICP NSX Edge ファイアウォールには、以下を許可するルールが構成されます。
*	パブリック・アクセスへの VXLAN ネットワーク・アクセスを有効にする。
*	プライベート IBM Cloud ネットワーク・アクセスへの VXLAN ネットワーク・アクセスを有効にする。
*	VXLAN ネットワークへのプライベート IBM Cloud ネットワーク・アクセスを有効にする。

### NSX NAT
ICP NSX NAT には、以下の NAT が構成されます。
*	パブリック・アクセスへの VXLAN ネットワーク・アクセスのための SNAT。
*	プライベート IBM Cloud ネットワーク・アクセスへの VXLAN ネットワーク・アクセスのための SNAT。
*	ICP クラスター vIP のための DNAT。

### 関連リンク

* [VMware vCenter Server on IBM Cloud with Hybridity Bundle](../vcs/vcs-hybridity-intro.html)
