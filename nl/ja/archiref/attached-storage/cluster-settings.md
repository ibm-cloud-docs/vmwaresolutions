---

copyright:

  years:  2016, 2018

lastupdated: "2018-10-29"

---

# クラスター設定

接続ストレージが追加されるまで、vCenter Server ソリューションでは、vSphere Distributed Resource Scheduler (DRS) や vSphere High Availability (HA) などの拡張機能は有効ではありません。 NFS 接続ストレージ・デバイスを追加することで、これらの機能はクラスターで有効になります。各機能の設定値を以下のセクションにリストしています。

## vSphere Distributed Resource Scheduler

クラスターで vSphere DRS が有効になると、「ロード・バランシング」と「パワー・マネジメント」という 2 つの主要な機能が有効になります。

### ロード・バランシング

ロード・バランシングを使用すると、クラスター内のすべてのホストと仮想マシン (VM) の CPU およびメモリー・リソースの分配と使用の状況が、絶えずモニターされます。 DRS は、クラスターのリソース・プールや VM の属性および現在の需要に照らして、理想的なリソース使用率とこれらのメトリックを比較します。そして、比較に基づいて VM の移行を実行または推奨します。

クラスターで VM が初めて起動すると、DRS はその VM を適切なホスト上に配置するか、または推奨情報を生成することによって、適切なロード・バランシングを維持しようとします。 配置または推奨の設定は、クラスター設定の DRS 自動化セクションで設定します。

この設計では、DRS 自動化レベルが完全自動化に設定されるので、VM は起動時に、十分な容量を持っているホストに自動的に配置されます。 また、クラスターのロード・バランシングのために、VM も特定のホストから別のホストに自動的に移行されます。 さらに、DRS クラスターの移行しきい値は、優先順位 1 の推奨、優先順位 2 の推奨、優先順位 3 の推奨が適用されるように、保守的と積極的の中間に設定されます。 つまり、vCenter Server では、クラスターのロード・バランシングについて、少なくとも必ず有効な改善が行われるようになります。

次の表に、vSphere DRS クラスターの VMware vSphere Web Client の設定を示しています。

表 1. vSphere DRS クラスターの DRS 自動化設定

| 設定             | 値  |
|:------------------- |:------ |
| vSphere DRS をオンにする | 選択済み |
| 自動化レベル | 完全自動化 |
| 移行のしきい値 | 優先順位 1、優先順位 2、優先順位 3 の各推奨を適用 |
| 各仮想マシンの自動化レベルを有効にする | 選択済み、15 ミリ秒に設定 |

vSphere Web Client のこれらの設定に関して詳しくは、[vSphere Web Client での仮想マシンのカスタム自動化レベルの設定](https://docs.vmware.com/en/VMware-vSphere/5.5/com.vmware.vsphere.resmgmt.doc/GUID-C21C0609-923B-46FB-920C-887F00DBCAB9.html)を参照してください。

クラスターの自動化レベルと移行しきい値に加えて、この設計では、VM の自動化も有効であるため、個々の VM のオーバーライドを設定できます。 これによって各 VM を細かく制御できるので、VM のロード・バランシングの優先順位を細かく設定できます。

### 電源管理

VMware Distributed Power Management 機能が有効な場合、DRS は、クラスターの VM の需要 (最近の需要履歴を含む) と、クラスター・レベルおよびホスト・レベルの容量を比較します。 容量が十分余っている場合はホストをスタンバイ・パワー・モードに移し (またはそうすることを推奨し)、容量が必要な場合は、ホストを起動します。 ホストの電源状態について生成された推奨情報に基づいて、VM をホスト間で移動しなければならない場合もあります。
この設計では、クラスター内でホストの電源をオン/オフする運用上、財政上のメリットがないため、電源管理は無効になっています。

## vSphere High Availability

vSphere は、VM および VM が配置されるホストをクラスターとしてプールすることで、VM の高可用性を実現します。 クラスター内のホストはモニターされ、障害が発生すると、障害が発生したホストの VM が別のホストで再起動されます。
この設計では、クラスター上のホスト・モニタリングおよび VM モニタリングとともに、vSphere High Availability が有効になっています。

### ホスト・モニタリング

ホスト・モニタリングによって、クラスター内のホストがネットワーク・ハートビートを交換し、障害検出時に vSphere HA がアクションを実行することが可能になります。 この設計では、この機能が有効になっています。

### 仮想マシンのモニタリング

VM のモニタリング機能では、ゲストのオペレーティング・システムの可用性を実現するためのプロキシーとして、VMware Tools がキャプチャーするハートビート情報が使用されます。 これによって、vSphere HA は、ハートビートを出せなくなった個々の VM を自動的にリセット/再起動できます。 この設計では VM とアプリケーションの両方のモニタリングが有効になっています。

#### 障害状況および VM 対応

障害状況では、VM の障害状況と、各障害に対する対応を定義します。 この設計では、VM の再起動の優先順位は「中」に設定されます。この値を見直し、再起動の優先順位がワークロードの重要度に一致するように設定を調整することを強く推奨します。 さらに、ホスト隔離時の対応は、「仮想マシンをパワーオフして再起動する」に設定されるので、クラスター内の隔離されたホストの影響を VM が受けることはありません。 この設定の残りの値はデフォルトに設定されます。

次の表に、vSphere HA クラスターの VMware vSphere Web Client の設定を示しています。

表 2. vSphere HA クラスターの障害状況と VM の対応の設定

| 設定             | 値  |
|:------------------- |:------ |
| 仮想マシン再起動の優先順位 | 中 |
| ホスト隔離時の対応 | 仮想マシンをパワーオフして再起動する |
| 永続的なデバイス損失 (PDL) 状態のデータ・ストアの対応 | 無効 |
| 全パス・ダウン (APD) 状態のデータ・ストアの対応 | 無効 |
| APD タイムアウト後に APD から回復する場合の対応 | 無効 |
| 仮想マシン監視の感度 | カスタム |
| 障害間隔 | 50 秒 |
| 最小アップタイム | 90 秒 |
| VM ごとの最大リセット回数 | 10 |
| 最大リセット回数の時間枠 | 1 時間以内 |

vSphere Web Client のこれらの設定に関して詳しくは、[仮想マシンの対応の構成](https://docs.vmware.com/en/VMware-vSphere/6.0/com.vmware.vsphere.avail.doc/GUID-3DAED2B1-55B8-4877-BD0F-BC57C10A516C.html)を参照してください。

#### アドミッション制御

vCenter Server では、クラスターに十分なリソースを確保してフェイルオーバー保護を実現するため、また、VM リソース予約が尊重されるようにするために、アドミッション制御を使用します。 この設計では、クラスター・リソースのパーセントを指定してフェイルオーバー容量を予約しています。 定義されるフェイルオーバー容量は、25% の CPU および 25% のメモリーです。

#### ハートビート用データ・ストア

vSphere HA は、データ・ストア・ハートビートを使用して、障害が発生したホストとネットワーク・パーティション上のホストを区別します。 データ・ストア・ハートビートによって、vSphere HA は、管理ネットワーク・パーティション障害の発生時にホストをモニターし、発生した障害に対する対応を継続できます。 この設計では、ハートビート・データ・ストア選択ポリシーが、「ホストからアクセス可能なデータ・ストアを自動的に選択する」に設定されます。

### 関連リンク

* [ソリューションの概要](../solution/solution_overview.html)
