---

copyright:

  years:  2016, 2019

lastupdated: "2019-04-02"

subcollection: vmware-solutions


---

{:tip: .tip}
{:note: .note}
{:important: .important}

# 仮想マシンのマイグレーション
{: #hcx-archi-migrate-vm}

HCX は、オンプレミスからクラウドへ、また、クラウドからオンプレミス・データ・センターへの双方向のマイグレーションを可能にします。 HCX は、マイグレーション・プロセス中にレプリケーション・テクノロジーを使用します。 ハイブリッド・クラウド・ゲートウェイの仮想アプライアンスには、レプリケーション・テクノロジーが組み込まれています。 レプリケーション・ソフトウェアを別途インストールする必要はありません。

## 最小ダウン時間マイグレーション

最小ダウン時間マイグレーションでは、ホスト・ベースのレプリケーションを使用し、稼働中の仮想マシンを vCenter から仮想データ・センター (またはその逆方向) へ移動します。 ダウン時間を短縮するために、ソース VM は、レプリケーション中はオンラインのままで、レプリケーション完了後に宛先 ESX ホストでブートストラップされます。

1. マイグレーション要求を行うと、次のアクションがトリガーされます。
  * レプリケーションにより、VCS HCX 仮想データ・センターへの完全同期転送が開始されます。 レプリケーションにかかる時間は、VM のサイズと使用可能な帯域幅に応じて異なります。
  * レプリケーションの帯域幅の消費量は、ワークロードがディスク上のブロックをどのように変更するかによって異なります。
2. 完全同期が終了すると、デルタ同期が行われます。
3. デルタ同期が終了すると、HCX によって切り替えがトリガーされます。 切り替えは即時に開始することも特定の時刻に開始するようにスケジュールすることもできます。
4. 切り替え後は、ソース VM が電源オフになり、マイグレーションしたレプリカが電源オンになります。 何らかの理由で VM を電源オンにできない場合は、新規 VM が電源オフ (つまり電源オフのまま) になり、元の VM が電源オンになります。
5. HCX は、マイグレーションした VM と名前が競合しないように、電源オフにした元の VM の名前を、元の VM 名にバイナリーのタイム・スタンプを付けたものに変更します。
6. **「MAC の保持 (Retain MAC)」**を有効にする指定をしなかった場合、マイグレーションした VM は新規 MAC アドレスを取得します。
7. マイグレーションは完了です。 ハイブリッド・クラウド・サービスにより、元の VM が vSphere のテンプレート・ビューの**「マイグレーション済みの VM (Migrated VMs)」**フォルダーにコピーされます。

## ゼロ・ダウン時間 vMotion
{: #hcx-archi-migrate-vm-no-downtime-vm}

vMotion では、稼働中の仮想マシンを vSphere vCenter から VCS クラウドに転送できます。 この vMotion には、拡張ネットワークが必要です。 vMotion 転送では、仮想マシンのアクティブ・メモリー、実行状態、IP アドレス、および MAC アドレスが保持されます。

仮想マシンのハードウェア・バージョンがバージョン 9 以上である必要があります。そうでない場合、クラウド間の vMotion は失敗する可能性があります。
{:note}

## コールド・マイグレーション
{: #hcx-archi-migrate-vm-cold-mig}

コールド・マイグレーションでは、クラウド間 vMotion と同じデータ・プレーンを使用し、電源オフの状態の仮想マシンを拡張ネットワーク経由で転送します。 仮想マシンの IP アドレスと MAC アドレスは保持されます。 仮想マシンの要件と制限は、vMotion の場合と同じです。

### 双方向ウィザードを使用した VM のマイグレーション
{: #hcx-archi-migrate-vm-mig-bidir-wiz}

双方向マイグレーション・ウィザードには、vSphere Web Client を使用して、ハイブリッド・クラウド・サービスの「開始 (Getting Started)」タブからアクセスできます。 このウィザードは、複数の仮想マシンを含め、マイグレーションのあらゆる詳細を処理できます。

双方向マイグレーション・ウィザードには、vSphere Web Client のハイブリッド・クラウド・サービスの「開始 (Getting Started)」タブからアクセスできます。 このウィザードは、複数の仮想マシンを含め、マイグレーションのあらゆる詳細を処理できます。
* vSphere から VCS ハイブリッド・クラウド・サービスへ
* VCS HCX クラウドから vSphere へ

### マイグレーション前の VM の確認
{: #hcx-archi-migrate-vm-check-vms}

仮想マシンをマイグレーションするには、ハイブリッド・クラウド・ゲートウェイによって維持されるセキュアな接続が必要です。また、VM が以下の要件を満たしている必要があります。
* 仮想マシンが電源オンになっている必要があります。
* オペレーティング・システムにかかわらず、基礎のアーキテクチャーが x86 である必要があります。
* vMotion マイグレーションを使用するには、ハードウェア・バージョンが 9 より大きくなければなりません。
* ハードウェア・バージョンは 10 より小さくなければなりません。
* 互換モードのロー・ディスク・マッピングを使用する VM は、マイグレーション可能です。

以下の性質を持つ VM のマイグレーションは、サポートされません。
* 2 TB を超えている。
* VMDK ファイルを共有している。
* 仮想メディアまたは ISO が接続されている。
* ハードウェア・バージョンが 9 より小さい。

### マイグレーションのモニタリング
{: #hcx-archi-migrate-vm-monitor-mig}

レプリケーション・ベースのマイグレーションの進行状況は、ユーザー・インターフェースまたはコマンド・ラインからモニターできます。 『サービス・アプライアンスのデプロイメントをモニターする』の説明に従って、タスク・コンソールを表示し、**「VM のマイグレーション (Migrate VM)」**タスクを探します。 状態が**「完了」**になっている場合、VM はマイグレーションされ、電源オンになっています。

この手順では、同じ vCenter に存在する無関係の VM を使用して、マイグレーションした VM の進行状況を追跡します。

1. マイグレーションする VM を識別し、マイグレーションする VM を ping できるオブザーバー VM を選択します。
2. ユーザー・インターフェースから、VM のマイグレーションを開始し、タスク・コンソールからモニターします。
3. SSH を使用して、オブザーバー VM を実行している ESXi ホストにログインします。
4. 次のコマンドを実行して、VM ID (vmid) を取得します。

  ```
  # vim-cmd vmsvc/getallvms | grep -i vmname 5
  ```

5. 以下のコマンドを実行して、レプリケーションの状態をモニターします。ここで、vmid は前の手順で取得した値です。

  ```
  # vim-cmd hbrsvc/vmreplica.getState vmid
  # vim-cmd hbrsvc/vmreplica.queryReplicationState vmid 6
  ```

6. ICMP ping - 前の手順で開始した ping の継続実行をモニターします。

切り替え中に、ping の継続実行が中断されることがあります。 しかし、タスク・コンソールに**「VM のマイグレーション (Migrate VM)」**タスクが完了したと表示されると、すぐにテスト ping が再開されます。

### マイグレーション済み VM の表示
{: #hcx-archi-migrate-vm-view-vms}

ハイブリッド・クラウド・サービスは、マイグレーションした仮想マシンの電源オンに成功すると、元の VM を電源オフにし、vCenter のフォルダーに保管します。 保管された仮想マシンは、手動で削除されるまで残ります。

マイグレーションが終わったら、vCenter を表示し、**「クラウドからマイグレーションされた VM (VMs migrated from the cloud)」**および**「クラウドにマイグレーションされた VM (VMs migrated to the cloud)」**というフォルダーに注目してください。
* 電源オフにされた元の VM は、レプリカとして、元の名前にバイナリー・タイム・スタンプが付いた名前になっています。
* マイグレーションした VM は、他の VM と同様に扱えます。 例えば、別の場所に移動したり、電源オンにしたりできます。
* これらのフォルダー内の不要な VM は削除できます。
* バックアップ・ソリューションが適用されていない場合、削除すると元に戻せません。

## 関連リンク
{: #hcx-archi-migrate-vm-related}

* [HCX の変更またはアンインストール](/docs/services/vmwaresolutions/archiref/hcx-archi?topic=vmware-solutions-hcx-archi-mod-uninstall)
