---

copyright:

  years:  2016, 2018

lastupdated: "2018-10-29"

---

# 集群设置

在添加连接的存储器之前，vCenter Server 解决方案不会启用 vSphere 分布式资源调度程序 (DRS) 和 vSphere 高可用性 (HA) 等高级功能。在添加 NFS 连接的存储设备后，会在集群上启用这些功能，具体设置如以下部分所示。

## vSphere 分布式资源调度程序

在集群上启用 vSphere DRS 时，会启用两个主要功能：负载均衡和电源管理。

### 负载均衡

使用负载均衡时，集群中所有主机和虚拟机 (VM) 的 CPU 和内存资源的分配和使用会持续受到监视。在给定集群的资源池和 VM 的属性以及当前需求的情况下，DRS 会将这些度量值与理想状态的资源利用率进行比较。然后，DRS 会相应地执行 VM 迁移或给出迁移建议。

在集群中首次开启 VM 时，DRS 会尝试通过将 VM 放置在适当的主机上或给出放置建议，以维持适当的负载均衡。放置或建议的相关设置可在集群设置的“DRS 自动化”部分中配置。

在此设计中，“DRS 自动化”的级别设置为完全自动化。因此，在开启 VM 后，会自动将 VM 放置在容量充足的主机上。还会自动将 VM 从一个主机迁移到另一个主机，从而使集群负载均衡。此外，还会权衡保守性和积极性来设置 DRS 集群的迁移阈值，以便应用优先级 1、优先级 2 和优先级 3 建议。这意味着，vCenter Server 至少能对集群的负载均衡起到良好的改进作用。

下表显示了 VMware vSphere Web Client 中 vSphere DRS 集群的设置。

表 1. vSphere DRS 集群的“DRS 自动化”设置

|设置|值|
|:------------------- |:------ |
|开启 vSphere DRS|已选|
|自动化级别|完全自动化|
|迁移阈值|应用优先级 1、优先级 2 和优先级 3 建议|
|启用单个机器自动化级别|已选，设置为 15 毫秒|

有关在 vSphere Web Client 中配置这些设置的更多信息，请参阅 [Set a Custom Automation Level for a Virtual Machine in the vSphere Web Client](https://docs.vmware.com/en/VMware-vSphere/5.5/com.vmware.vsphere.resmgmt.doc/GUID-C21C0609-923B-46FB-920C-887F00DBCAB9.html)。

除了集群的自动化级别和迁移阈值，此设计还可实现 VM 自动化，因此可针对单个 VM 设置覆盖。这样就可以更精确地控制 VM，以便进一步确定 VM 负载均衡的优先级。

### 电源管理

在启用 VMware 分布式电源管理功能时，DRS 会将集群级别和主机级别的容量与集群的 VM 需求（包括最新的历史需求）进行比较。如果找到足够的过剩容量，DRS 会将（或建议将）主机置于备用电源模式。如果需要容量，那么会开启主机电源。对于 VM，可能需要将其迁移到主机或从主机中迁出，具体取决于生成的主机电源状态建议。在此设计中，电源管理为禁用状态，因为开启和关闭集群中主机的电源没有任何操作或财务上的好处。

## vSphere 高可用性

vSphere 通过将 VM 及其所在的主机聚集到一个集群中，为 VM 提供高可用性。集群中的主机会受到监视，如果发生故障，即会在备用主机上重新启动发生故障的主机上的 VM。在此设计中，vSphere 高可用性是通过在集群上执行主机监视和 VM 监视来实现的。

### 主机监视

使用主机监视时，集群中的主机可以交换网络脉动信号，而且 vSphere HA 可以在检测到故障时采取相应措施。在此设计中，此功能为启用状态。

### 虚拟机监视

VM 监视功能使用 VMware Tools 代为捕获的脉动信号信息来提供访客操作系统可用性。这样，vSphere HA 就可以自动重置或重新启动无法发出脉动信号的单个 VM。此设计支持 VM 监视和应用程序监视。

#### 故障条件和 VM 响应

故障条件定义了 VM 的故障情况以及针对每个故障所提供的响应。在此设计中，VM 重新启动优先级设置为中；强烈建议您查看此值并相应地调整设置，以使重新启动优先级与工作负载的重要性相匹配。此外，对主机隔离的响应设置为“关闭并重新启动 VM”，因此 VM 不会受到集群中隔离的主机的影响。此设置的其余值均为缺省设置。

下表显示了 VMware vSphere Web Client 中 vSphere HA 集群的设置。

表 2. vSphere HA 集群的故障条件和 VM 响应设置

|设置|值|
|:------------------- |:------ |
|VM 重新启动优先级|中|
|对主机隔离的响应|关闭并重新启动 VM|
|对永久设备丢失 (PDL) 的数据存储的响应|已禁用|
|对所有路径异常 (APD) 的数据存储的响应|已禁用|
|对 APD 超时后 APD 恢复的响应|已禁用|
|VM 监视敏感度|定制|
|故障时间间隔|50 秒|
|最短正常运行时间|90 秒|
|每个 VM 的最大重置数|10|
|最长重置时间窗口|1 小时内|

有关在 vSphere Web Client 中配置这些设置的更多信息，请参阅 [Configure Virtual Machine Responses](https://docs.vmware.com/en/VMware-vSphere/6.0/com.vmware.vsphere.avail.doc/GUID-3DAED2B1-55B8-4877-BD0F-BC57C10A516C.html)。

#### 许可控制

vCenter Server 使用许可控制来确保集群中有足够的资源可用于提供故障转移保护，并且遵循 VM 资源保留协议。在此设计中，故障转移容量是通过指定集群资源的百分比来保留的。定义的故障转移容量设置为 25% CPU 和 25% 内存。

#### 用于脉动信号的数据存储

vSphere HA 使用数据存储脉动信号来区分发生故障的主机和位于网络分区中的主机。使用数据存储脉动信号时，vSphere HA 可以在发生管理网络分区时监视主机，并继续对发生的故障进行响应。在此设计中，脉动信号数据存储选择策略设置为“自动选择可从主机访问的数据存储”。

### 相关链接

* [解决方案概述](../solution/solution_overview.html)
