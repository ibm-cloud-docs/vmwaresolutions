---

copyright:

  years:  2016, 2019

lastupdated: "2019-01-23"

---

{:tip: .tip}
{:note: .note}
{:important: .important}

# 编译打包和修复

可以选择在修复之前对补丁和扩展进行编译打包，以确保在未直接应用补丁或扩展的情况下，将其从 VUM 下载到 vSphere ESXi 主机。在修复期间，VUM 会将补丁、扩展和升级应用于库存对象。对补丁和扩展编译打包可加速修复过程，因为补丁和扩展已在主机上以本地方式提供。

如果在修复过程中，任何主机无法进入维护模式，那么 VUM 会报告错误，并且修复过程会停止并失败。已修复的 vSphere ESXi 主机会保持更新后的级别。

为了使修复过程顺利进行，建议禁用某些集群功能（例如，DPM、HA 许可控制和容错），并且从虚拟机 (VM) 断开任何可移动设备的连接，以便在将 VM 迁移到其他主机时，DRS 不会发生任何问题。此外，在运行修复向导时，可以“生成报告”来验证在主机/VM 级别是否不存在可能会导致修复过程失败的不一致设置。

1. 使用 vSphere Web Client，选择**主页** > **主机和集群**。
2. 右键单击数据中心、集群或主机，并单击**编译打包补丁**。
3. 在“编译打包”向导的“基线选择”页面上，选择要编译打包的补丁和扩展基线。
4. 选择将应用补丁和扩展的主机，然后单击**下一步**。如果选择了将补丁和扩展编译打包到单个主机，那么缺省情况下已选择该主机。
5. （可选）清除要排除在编译打包操作之外的补丁和扩展。要在补丁和扩展的列表中进行搜索，请在“过滤器”框的文本框中输入文本。单击**下一步**。
6. 复查**即将完成**页面，然后单击**完成**。

特定主机的已编译打包的补丁和扩展的数量会在 Update Manager 选项卡底部窗格的“补丁和扩展”列中显示。成功完成修复操作后，将从主机中删除所有编译打包的补丁和扩展（无论是否在修复期间已安装）。在修复过程中，VUM 会在扫描完成后应用 vSphere ESXi 主机、VM 或虚拟设备的补丁、扩展和升级，并使所选对象合规。可以修复单个主机、VM 或虚拟设备，也可以在文件夹、集群或数据中心级别进行修复。VUM 支持使用手动修复或安排的修复来修复以下库存对象：
* 要进行补丁、扩展和升级修复的 ESXi 主机。
* 要进行 VMware Tools 和 VM 硬件升级的已打开电源、已暂挂或已关闭电源的 VM 和模板。
* 要进行虚拟设备升级的已打开电源的虚拟设备（使用 VMware Studio 2.0 及更高版本创建）。

如果更新需要，可在修复之前将主机置于维护模式。在将主机置于维护模式之前，VCSA 会将 VM 迁移到 VMware vCenter Server on {{site.data.keyword.cloud}} 实例内的其他主机。

## 对于 vSAN 集群中的主机
请注意属于 vSAN 集群的主机的以下行为：
* 主机修复过程可能需要很长时间才能完成。
* 根据设计，任一时间 vSAN 集群中只能有一台主机可以处于维护模式。
* 对于属于 vSAN 集群的主机，即便设置了用于并行修复主机的选项，VUM 也会按顺序修复这些主机。
* 如果主机上有任何 VM 使用的 VM 存储策略的**容错数**设置为 0，那么主机在进入维护模式时可能会遇到异常延迟。发生此延迟的原因是，vSAN 必须将 VM 数据从 vSAN 数据存储集群中的一个磁盘迁移到另一个磁盘，这可能需要许多个小时。对此，可采用的变通方法是将 VM 存储策略的**容错数**设置为 1，这将在 vSAN 数据存储中创建 VM 文件的两个副本。
* 如果主机上有任何 VM 使用的 VM 存储策略的**容错数**设置为 1，那么主机在进入维护模式时，VM 会变为非冗余。如果这是不可接受的情况，请参阅[虚拟机 vSAN 冗余](/docs/services/vmwaresolutions/archiref/vum/vum-vsan-redundancy.html)。

要修复主机和集群，请执行以下步骤：
1. 使用 vSphere Web Client，选择**主页** > **主机和集群**。
2. 在库存对象导航器中，选择数据中心、集群或主机，单击 **Update Manager** 选项卡，然后单击**修复**。如果选择了容器对象，那么将修复所选对象下的所有主机。这将打开“修复”向导。
3. 根据要对主机执行的更新类型，选择**补丁基线**或**扩展基线**。在“修复”向导的“选择基线”页面上，选择要应用的**基线组**和**基线**。
4. 选择要修复的目标主机，然后单击**下一步**。如果选择了对单个主机而非容器对象进行修复，那么缺省情况下已选择该主机。
5. （可选）在**补丁和扩展**页面上，清除要排除在修复过程之外的特定补丁或扩展，然后单击**下一步**。
6. （可选）在**高级选项**页面上，选择用于将修复安排在日后运行的选项，并为该任务指定唯一名称和可选描述。为安排的任务设置的时间是 VCSA 上的时间。（可选）选择用于忽略有关主机上不支持的设备或不再支持的 VMFS 数据存储的警告的选项，以继续进行修复。单击**下一步**。
7. 在主机**修复选项**页面上，从 **VM 电源状态**下拉菜单中，可以选择更改要修复的主机上运行的 VM 和虚拟设备的电源状态。在主机上的 VM 已关闭电源、已暂挂或已通过 vMotion 迁移到 DRS 集群中的其他主机之后，该主机才能进入维护模式。某些更新需要主机在修复之前进入维护模式。主机处于维护模式时，VM 和设备无法运行。要以牺牲 VM 可用性为代价缩短主机修复停机时间，您可以选择在修复之前关闭或暂挂 VM 和虚拟设备。在 DRS 集群中，如果未关闭 VM 的电源，那么修复过程需要更长时间，但 VM 在整个修复过程中可用，因为这些 VM 已通过 vMotion 迁移到其他主机。选择如下所示：

- **关闭虚拟机电源** - 修复之前，关闭所有 VM 和虚拟设备的电源。
- **暂挂虚拟机** - 修复之前，暂挂所有正在运行的 VM 和虚拟设备。
- **不更改 VM 电源状态** - 使 VM 和虚拟设备保持其当前电源状态不变。

8. （可选）选择**禁用连接到主机上虚拟机的任何可移动介质设备**。VUM 不会修复其上的 VM 已连接 CD、DVD 或软盘驱动器的主机。在集群环境中，如果目标主机没有完全相同的设备或未安装 ISO 映像，那么连接的介质设备可能会阻止 vMotion，进而会阻止源主机进入维护模式。修复后，VUM 将重新连接可移动介质设备（如果这些设备仍然可用）。
9. （可选）选择**失败时重试进入维护模式**，指定重试次数，并指定重试之间的等待时间。VUM 会等待重试延迟时间段，并重试将主机置于维护模式，最大重试次数为您在“重试次数”字段中指示的次数。

在 vCenter Server 实例中，无需选中“ESXi 补丁设置”下的复选框，以使 Update Manager 对已打开电源的 PXE 引导的 ESXi 主机进行修补。
10. 单击**下一步**。
11. 如果修复集群中的主机，请编辑集群修复选项。仅当修复集群时，**集群修复选项**页面才可用。可以选择以下选项：
* **禁用分布式电源管理 (DPM)**（如果对任何所选集群启用了 DPM）- VUM 不会修复具有活动 DPM 的集群。DPM 会监视集群中正在运行的 VM 的资源使用情况。如果存在足够的过剩容量，DPM 会建议将 VM 移至集群中的其他主机，并将原始主机置于备用模式以节约电力。将主机置于备用模式可能会中断修复。
* **禁用高可用性许可控制**（如果对任何所选集群启用了高可用性许可控制）- VUM 不会修复具有活动 HA 许可控制的集群。许可控制是 VMware HA 用于确保集群内故障转移能力的策略。如果 HA 许可控制在修复期间处于启用状态，那么集群内的 VM 可能无法通过 vMotion 进行迁移。
* **禁用容错 (FT)**（如果启用了容错）。这会影响所选集群中的所有容错 VM。如果对主机上的任何 VM 启用了 FT，那么 VUM 不会对该主机进行修复。要启用 FT，运行主 VM 和辅助 VM 的主机必须为相同版本，并且必须安装有相同的补丁。如果对这些主机应用不同的补丁，那么无法重新启用 FT。
* **对所选集群中的主机启用并行修复** - 以并行方式修复集群中的主机。如果未选择此设置，VUM 将按顺序修复集群中的主机。您可以为并行修复选择下列其中一个选项：
  - 可以让 VUM 持续对在不中断 DRS 设置的情况下可以并发修复的最大主机数求值。
  - 可以指定对修复的每个集群中并发修复的主机数的限制。请注意，VUM 仅对其上的 VM 已关闭电源或已暂挂的主机进行并发修复。您可以从“主机修复选项”页面上“维护模式选项”窗格中的“VM 电源状态”菜单中选择关闭 VM 电源或暂挂 VM。根据设计，任一时间 vSAN 集群中只能有一台主机可以处于维护模式。对于属于 vSAN 集群的主机，即便选择用于并行修复主机的选项，VUM 也会按顺序修复这些主机。
* **将已关闭电源和已暂挂的虚拟机迁移到集群中的其他主机**（如果主机必须进入维护模式）。Update Manager 会将必须进入维护模式的主机中已暂挂和已关闭电源的 VM 迁移到集群中的其他主机。修复之前，可以在**维护模式设置**窗格中，选择关闭 VM 电源或暂挂 VM。
12. 在“即将完成”页面上，可以选择单击**预检查修复**以生成集群修复选项报告，然后单击**确定**。这将打开“集群修复选项报告”对话框。您可以导出此报告，也可以复制自己的记录的条目，然后单击**下一步**。
13. 复查**即将完成**页面，然后单击**完成**。

### 相关链接

* [VMware HCX on {{site.data.keyword.cloud_notm}} 解决方案体系结构](https://www.ibm.com/cloud/garage/files/HCX_Architecture_Design.pdf)
* [VMware Solutions on {{site.data.keyword.cloud_notm}} 数字技术互动](https://ibm-dte.mybluemix.net/ibm-vmware)（演示）
