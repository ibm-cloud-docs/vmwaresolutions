---

copyright:

  years:  2016, 2018

lastupdated: "2018-10-29"

---

#	编排的升级

在更新 vSphere ESXi 主机之后，可以使用编排的升级来升级库存中虚拟机的虚拟硬件和 VMware Tools。更新主机后，将首先运行 VMware Tools 升级基线，然后运行虚拟机硬件升级基线。可以在集群、文件夹或数据中心级别执行编排的升级。

VUM 允许您使用基线组来执行先主机后虚拟机的编排升级。将使用包含单个主机升级基线和多个补丁或扩展基线的基线组。VUM 会首先升级主机，然后应用补丁或扩展基线。使用包含以下基线的虚拟机基线组可执行虚拟机的编排升级：
* VM 硬件升级以匹配主机
* VMware Tools 升级以匹配主机

通过 VUM 编排的升级，可以在分为两步的过程中升级 VCSA 中的库存对象。首先升级 vSphere ESXi 主机，然后升级虚拟机。这一分为两步的过程可以在集群级别进行配置，也可以在单个 vSphere ESXi 主机或虚拟机级别配置此过程，从而实现更精细的控制。

在编排的升级中，将首先根据主机基线组来修复集群，这将应用补丁、扩展和升级；升级后，将根据包含“VM 硬件升级以匹配主机”和“VMware Tools 升级以匹配主机”基线的虚拟机升级基线组来修复集群中的虚拟机。

如果基线组还包含升级基线，那么 VUM 会先升级 vSphere ESXi 主机，然后应用补丁和/或扩展基线，因为补丁适用于特定主机版本。对于虚拟机，会首先更新 VMware Tools，然后更新虚拟硬件。

因此，在 VMware Tools 升级期间，会打开虚拟机的电源；如果虚拟机处于电源关闭或暂挂状态，那么 VUM 将打开这些虚拟机的电源，运行升级，然后将虚拟机复原为其原始电源状态。因此，在虚拟硬件升级期间，VM 必须处于电源关闭状态；如果虚拟机处于电源打开状态, VUM 将关闭这些虚拟机的电源，升级虚拟硬件，然后重新打开这些虚拟机的电源。

缺省情况下，对 vSphere ESXi 主机的修复会按顺序执行，并且一次修复一个主机。针对一个主机完成此过程后，VUM 会开始修复下一个主机。可以更改此缺省值以启用并行修复，以便一次可以修复多个主机，但是，仅当集群中有足够的故障转移容量时，才可以这样做。

如果 vSphere ESXI 主机是 vSAN 集群的一部分，那么即使您已在修复向导中选择了并行修复，修复过程也始终按顺序执行，这是因为任一时间 vSAN 集群中都只能有一台主机可以处于维护模式。VUM 非常智能，会计算可以在不中断 DRS 设置的情况下并行修复的主机数。

或者，您可以定义在修复向导执行期间可并行修复的主机数限制。

以下工作流程描述了用于执行编排升级的过程：

## 步骤 1

1. 使用 vSphere Web Client 登录到 VCSA。
2. 选择**主页** > **Update Manager**，然后在**对象**选项卡中，选择 **Update Manager 实例**。
3. 单击**管理**选项卡，单击**主机基线**选项卡，然后单击**新建基线组**。
4. 输入基线组的唯一名称，然后单击**下一步**。
5. 选择要在基线组中包含的主机升级基线。
6. （可选）通过单击“升级”页面底部的**新建主机升级基线**，并完成“新建基线”向导，以创建新的主机升级基线。单击**下一步**。
7. 选择要包含在基线组中的补丁基线。
8. （可选）通过单击“补丁”页面底部的**新建主机补丁基线**，并完成“新建基线”向导，以创建新的补丁基线。单击**下一步**。
9. 选择要包含在基线组中的扩展基线。
10. （可选）通过单击“补丁”页面底部的**新建扩展基线**，并完成“新建基线”向导，以创建新的扩展基线。
11. 复查“即将完成”页面，单击**完成**，该主机基线组将显示在“基线组”窗格中。

## 步骤 2

1. 在 VUM 的“管理”视图中，创建包含“VMware Tools 升级以匹配主机”基线和“VM 硬件升级以匹配主机”基线的虚拟机基线组。
2. 将基线组连接到包含要升级的虚拟机的 vCenter 容器对象。
3. 扫描容器对象以查看容器中虚拟机的一致性状态。您可以手动启动扫描，也可以安排扫描任务。
4. 查看 VUM 客户机的“一致性”视图中显示的扫描结果。
5. 修复容器对象中不一致的虚拟机，以使其与连接的基线组一致。您可以手动启动修复，也可以安排修复任务。
* 在 VMware Tools 升级期间，虚拟机电源必须打开。如果虚拟机在修复之前处于电源关闭或暂挂状态，那么 VUM 会打开该虚拟机的电源。完成升级后，VUM 将重新启动虚拟机并使其复原为原始电源状态。
* 在虚拟机硬件升级期间，必须关闭虚拟机。修复完成后，VUM 会将虚拟机复原为其原始电源状态。如果虚拟机处于电源打开状态，那么 VUM 将关闭该虚拟机的电源，升级虚拟硬件，然后打开该虚拟机的电源。

现在，您可以在扫描、复查、编译打包和修复过程中使用这些基线组。

### 相关链接

* [VMware HCX on IBM Cloud 解决方案体系结构](https://www.ibm.com/cloud/garage/files/HCX_Architecture_Design.pdf)
* [VMware Solutions on IBM Cloud 数字技术互动](https://ibm-dte.mybluemix.net/ibm-vmware)（演示）
