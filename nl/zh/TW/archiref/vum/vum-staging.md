---

copyright:

  years:  2016, 2019

lastupdated: "2019-03-13"

subcollection: vmwaresolutions


---

{:tip: .tip}
{:note: .note}
{:important: .important}

# 編譯打包及補救
{: #vum-staging}

在補救之前可以選擇性地編譯打包修補程式及延伸規格，確保將它們從 VUM 下載至 vSphere ESXi 主機，而不需要立即套用修補程式或延伸規格。在補救期間，VUM 會將修補程式、延伸規格及升級套用至庫存物件。編譯打包修補程式及延伸規格可加快補救處理程序，因為已可以在主機上本端使用這些修補程式及延伸規格。

如果在補救處理程序期間有任何主機無法進入維護模式，則 VUM 會報告錯誤，而且補救處理程序會停止並失敗。已修補的 vSphere ESXi 主機則會保留在已更新層次。

為了讓補救處理程序能夠順利運作，建議您停用某些叢集特性，例如 DPM、「HA 許可控制」、「容錯」，以及中斷所有抽取式裝置與虛擬機器 (VM) 的連線，以避免在將 VM 移轉至其他主機時發生 DRS 問題。
此外，執行補救精靈時，您可以「產生報告」來驗證主機/VM 層次上沒有任何可能會造成補救處理程序失敗的不一致設定。

1. 使用 vSphere Web Client，選取**首頁** > **主機及叢集**。
2. 用滑鼠右鍵按一下資料中心、叢集或主機，然後按一下**編譯打包修補程式**。
3. 在「編譯打包」精靈的「基準線選擇」頁面上，選取要編譯打包的修補程式及延伸規格基準線。
4. 選取會套用修補程式及延伸規格的主機，然後按**下一步**。如果您選擇將修補程式及延伸規格編譯打包至單一主機，則依預設會選取它。
5. 可選擇清除要從編譯打包作業中排除的修補程式及延伸規格。若要在修補程式及延伸規格清單內搜尋，請在「過濾」方框的文字框中輸入文字。按**下一步**。
6. 檢閱**準備完成**頁面，然後按一下**完成**。

在 Update Manager 標籤底端窗格的「修補程式」及「延伸規格」直欄中，會顯示特定主機的已編譯打包修補程式及延伸規格數目。補救順利完成之後，將會從主機刪除所有已編譯打包的修補程式及延伸規格（不論在補救期間是否已安裝）。
補救是一種處理程序，在掃描完成之後，VUM 會套用修補程式、延伸及升級至 vSphere ESXi 主機、VM 或虛擬應用裝置，並讓選取的物件遵循法規。您可以重新修補單一主機、VM 或虛擬應用裝置，或是在資料夾、叢集或資料中心層次重新修補。VUM 使用手動補救或排定的補救，來支援下列庫存物件的補救：
* 用於修補程式、延伸規格及升級補救的 ESXi 主機。
* 已開啟電源、已暫停或已關閉的 VM，以及用於 VMware Tools 和 VM 硬體升級的範本。
* 已開啟利用 VMware Studio 2.0 以及更新版本所建立之虛擬應用裝置的電源，以進行虛擬應用裝置升級。

如果更新需要它，則主機會在補救之前進入維護模式。在將主機置入維護模式之前，VCSA 會將 VM 移轉至 VMware vCenter Server on {{site.data.keyword.cloud}} 實例內的其他主機。

## 若為 vSAN 叢集中的主機
{: #vum-staging-hosts-vsan}

針對屬於 vSAN 叢集的主機，請注意下列行為：
* 主機補救處理程序可能需要相當長的時間才能完成。
* 根據設計，VSAN 叢集裡一次只能有一部主機處於維護模式。
* 即使您設定平行重新修補主機的選項，VUM 仍會循序重新修補屬於 VSAN 叢集的主機。
* 主機上若有任何 VM 的 VM 儲存空間原則將**要容忍的失敗次數**設定為 0，則主機可能會在進入維護模式時遇到不尋常的延遲。發生此延遲是因為 vSAN 必須將 VM 資料從某個磁碟移轉至 vSAN 資料儲存庫叢集中的另一個磁碟，而這可能需要數小時之久。您可以針對 VM 儲存空間原則將**要容忍的失敗次數**設定為 1 來暫時解決此問題，這會導致在 vSAN 資料儲存庫中建立兩份 VM 檔案。
* 主機上若有任何 VM 的 VM 儲存空間原則將**要容忍的失敗次數**設定 1，則 VM 會在主機進入維護模式時變成非備用。如果這是不可接受的，請參閱[虛擬機器 vSAN 備援](/docs/services/vmwaresolutions/archiref/vum?topic=vmware-solutions-vum-vsan-redundancy)。

若要重新修補主機及叢集，請遵循下列步驟：
1. 使用 vSphere Web Client，選取**首頁** > **主機及叢集**。
2. 從庫存物件導覽器中，選取資料中心、叢集或主機，按一下 **Update Manager** 標籤，然後按一下**重新修補**。如果您已選取容器物件，則會重新修補所選取物件下的所有主機。即會開啟「重新修補」精靈。
3. 根據您要在主機上執行的更新類型，選取**修補程式基準線**或**延伸規格基準線**。在「重新修補」精靈的「選取基準線」頁面上，選取要套用的**基準線群組**及**基準線**。
4. 選取您要重新修補的目標主機，然後按**下一步**。如果您選擇重新修補單一主機，而非容器物件，則依預設會選取該主機。
5. 可選擇在**修補程式及延伸規格**頁面上，清除特定修補程式或延伸規格，以將它們從補救處理程序中予以排除，然後按**下一步**。
6. 可選擇在**進階選項**頁面上，選取排定稍後執行補救的選項，然後指定作業的唯一名稱及選用說明。您針對已排定作業所設定的時間就是 VCSA 上的時間。可選擇選取忽略有關主機上不受支援裝置之警告的選項，或不再支援 VMFS 資料儲存庫繼續進行補救。按**下一步**。
7. 您可以從**主機補救選項**頁面的 **VM 電源狀態**下拉功能表中，選取在要補救的主機上執行的 VM 及虛擬應用裝置的電源狀態變更。除非主機上的 VM 關閉電源、暫停或使用 vMotion 移轉至 DRS 叢集中的其他主機，否則主機無法進入維護模式。部分更新需要主機在補救之前進入維護模式。主機處於維護模式時，VM 及應用裝置無法執行。若要以犧牲 VM 可用性作為代價來減少主機補救關閉時間，您可以選擇在進行補救之前，關閉或暫停 VM 及虛擬應用裝置。在 DRS 叢集中，如果您未關閉 VM 的電源，則補救需要更久的時間，但 VM 在整個補救處理程序期間可供使用，因為它們是使用 vMotion 移轉至其他主機。選項如下：

- **關閉虛擬機器電源** - 在進行補救之前，請關閉所有 VM 及虛擬應用裝置的電源。
- **暫停虛擬機器** - 在進行補救之前，請暫停所有執行中的 VM 及虛擬應用裝置。
- **不要變更 VM 電源狀態** - 讓 VM 及虛擬應用裝置處於其現行電源狀態。

8. 可選擇選取**停用任何連接至主機上虛擬機器的抽取式媒體裝置**。VUM 不會重新修補其 VM 已連接 CD、DVD 或軟式磁碟機的主機。在叢集環境中，如果目的地主機沒有相同的裝置或已裝載的 ISO 映像檔，則已連接的媒體裝置可能會阻止進行 vMotion，進而阻止來源主機進入維護模式。補救之後，VUM 會重新連接抽取式媒體裝置（如果它們仍然可用）。
9. 可選擇選取**在失敗時重試進入維護模式**，指定重試次數，然後指定重試之間的等待時間。VUM 會等待重試延遲期間，並重試讓主機進入維護模式，而重試次數就是您在「重試次數」欄位中指出的次數。

在 vCenter Server 實例中不需要選取「ESXi 修補程式設定」下的勾選框，讓 Update Manager 能夠修補已開啟電源的 PXE 開機 ESXi 主機。
10. 按**下一步**。
11. 如果您重新修補叢集裡的主機，請編輯叢集補救選項。只有在您重新修補叢集時，才能使用**叢集補救選項**頁面。以下是可選取的選項：
* **停用分散式電源管理 (DPM)**（如果已針對任何選取的叢集啟用）- VUM 不會重新修補具有作用中 DPM 的叢集。DPM 會監視叢集內執行中 VM 的資源使用情形。如果有足夠的過剩容量，DPM 會建議將 VM 移至叢集中的其他主機，並讓原始主機進入待命模式，以節省電源。讓主機進入待命模式可能會岔斷補救。
* **停用高可用性許可控制**（如果已針對任何選取的叢集啟用）- VUM 不會重新修補具有作用中 HA 許可控制的叢集。許可控制是 VMware HA 用來確保叢集內失效接手容量的原則。如果在補救期間啟用 HA 許可控制，則叢集內的 VM 可能不會使用 vMotion 移轉。
* **停用容錯 (FT)**（如果已啟用）。這會影響所選取叢集中的所有容錯 VM。如果已針對主機上的任何 VM 開啟 FT，則 VUM 不會重新修補該主機。若要啟用 FT，則執行「主要 VM」和「次要 VM」的主機必須具有相同的版本，而且必須已安裝相同的修補程式。如果您將不同的修補程式套用至這些主機，則無法重新啟用 FT。
* **啟用所選取叢集裡主機的平行補救** - 平行重新修補叢集裡的主機。如果未選取此設定，VUM 會循序重新修補叢集裡的主機。您可以選取下列其中一個選項，以進行平行補救：
  - 您可以讓 VUM 持續評估它可以同時重新修補的主機數目上限，而不中斷 DRS 設定。
  - 您可以指定在每個叢集裡重新修補的並行重新修補主機數目限制。請注意，VUM 只會同時重新修補已關閉 VM 電源或已暫停 VM 的主機。您可以在「主機補救選項」頁面上，從「維護模式選項」窗格的「VM 電源狀態」功能表中，選擇關閉 VM 電源或暫停 VM。根據設計，vSAN 叢集裡一次只能有一部主機處於維護模式。即使您選取平行重新修補主機的選項，VUM 仍會循序重新修補屬於 vSAN 叢集的主機。
* **將已關閉電源的虛擬機器及已暫停的虛擬機器移轉至叢集裡的其他主機**（如果主機必須進入維護模式）。Update Manager 會將已暫停及已關閉電源的 VM 從必須進入維護模式的主機中移轉至叢集中的其他主機。在進行補救之前，您可以在**維護模式設定**窗格中選擇關閉 VM 電源或暫停 VM。
12. 在「準備完成」頁面上，您可以選擇按一下**事先檢查補救**來產生叢集補救選項報告，然後按一下**確定**。即會開啟「叢集補救選項報告」對話框。您可以匯出這份報告，或複製您自己記錄的項目，然後按**下一步**。
13. 檢閱**準備完成**頁面，然後按一下**完成**。

## 相關鏈結
{: #vum-staging-related}

* [VMware HCX on {{site.data.keyword.cloud_notm}} 解決方案架構](/docs/services/vmwaresolutions/services?topic=vmware-solutions-hcx-archi-intro#hcx-archi-intro)
* [VMware Solutions on {{site.data.keyword.cloud_notm}} Digital Technical Engagement](https://ibm-dte.mybluemix.net/ibm-vmware)（示範）
